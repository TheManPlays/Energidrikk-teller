<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Energidrikk-teller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      margin: 24px;
      padding: 24px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, #1d4ed8 0, #020617 55%);
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148,163,184,0.4);
      box-sizing: border-box;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.9rem;
    }

    h2 {
      margin-top: 0;
      font-size: 1.3rem;
    }

    h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
    }

    p {
      margin: 0 0 8px 0;
    }

    .subtitle {
      color: #9ca3af;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .card {
      background-color: rgba(15,23,42,0.9);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(75,85,99,0.8);
      box-sizing: border-box;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #cbd5f5;
    }

    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background-color: #020617;
      color: #e5e7eb;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #0b1120;
      font-weight: 600;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.1s ease-out;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(34,197,94,0.45);
      filter: brightness(1.05);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      filter: brightness(0.95);
    }

    button.secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid #4b5563;
      box-shadow: none;
    }

    button.secondary:hover {
      box-shadow: 0 4px 10px rgba(15,23,42,0.8);
    }

    button.danger {
      background: #b91c1c;
      color: #fee2e2;
    }

    button.danger:hover {
      box-shadow: 0 8px 18px rgba(185,28,28,0.5);
      filter: brightness(1.05);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .hidden {
      display: none;
    }

    .error {
      color: #fecaca;
      font-size: 0.85rem;
      min-height: 1.2em;
      margin-top: 6px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .welcome {
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      background-color: rgba(15,23,42,0.9);
      border: 1px solid #374151;
      color: #e5e7eb;
      margin-bottom: 10px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle, #22c55e 0, #16a34a 45%, #166534 100%);
    }

    .brand {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      background-color: #020617;
      border: 1px solid #1f2937;
    }

    .brand-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
    }

    .brand-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .brand-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .brand-total {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .brand-toggle-icon {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .brand-body {
      margin-top: 4px;
    }

    .brand-body.collapsed {
      display: none;
    }

    .flavor-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-top: 1px dashed #1f2937;
      font-size: 0.9rem;
      gap: 8px;
    }

    .flavor-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .flavor-name {
      font-weight: 500;
    }

    .flavor-count {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .flavor-actions {
      display: flex;
      gap: 6px;
    }

    .price-line {
      font-size: 0.9rem;
      margin: 2px 0 8px 0;
      color: #e5e7eb;
    }

    .price-note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .chart-wrapper {
      position: relative;
      height: 180px;
      width: 100%;
    }

    .leader-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 4px 0;
      border-top: 1px dashed #1f2937;
    }

    .leader-name {
      color: #e5e7eb;
    }

    .leader-value {
      color: #9ca3af;
    }

    /* layout for main + sidebar */
    .app-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    .app-main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-side {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .container {
        max-width: 100%;
      }
      .app-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .container {
        margin: 16px;
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Energidrikk-teller</h1>
      <p class="subtitle">
        Trykk på + hver gang du drikker en enhet.
      </p>
    </header>

    <!-- INNLOGGING / REGISTRERING -->
    <section id="auth-section">
      <div class="grid">
        <div class="card">
          <h2>Ny bruker</h2>
          <p>Registrer deg med e-post eller telefonnummer og passord.</p>
          <form id="register-form">
            <div style="margin-bottom: 10px;">
              <label for="register-email">E-post eller telefonnummer</label>
              <input id="register-email" type="email" required />
            </div>
            <div style="margin-bottom: 10px;">
              <label for="register-password">Passord</label>
              <input id="register-password" type="password" minlength="6" required />
            </div>
            <button type="submit">Registrer konto</button>
          </form>
        </div>

        <div class="card">
          <h2>Logg inn</h2>
          <p>Har du allerede en konto? Logg inn her.</p>
          <form id="login-form">
            <div style="margin-bottom: 10px;">
              <label for="login-email">E-post eller telefonnummer</label>
              <input id="login-email" type="email" required />
            </div>
            <div style="margin-bottom: 10px;">
              <label for="login-password">Passord</label>
              <input id="login-password" type="password" required />
            </div>
            <button type="submit">Logg inn</button>
          </form>
          <p id="auth-error" class="error"></p>
        </div>
      </div>
    </section>

    <!-- SELVE APPEN (NÅR MAN ER INNLOGGET) -->
    <section id="app-section" class="hidden">
      <div class="top-bar">
        <div class="welcome">
          <span id="welcome-text"></span>
        </div>
        <button id="logout-btn" class="secondary">Logg ut</button>
      </div>

      <div class="app-grid">
        <!-- Venstre side -->
        <div class="app-main">
          <!-- Graf -->
          <div class="card">
            <h2>Forbruk per måned</h2>
            <div class="chart-wrapper">
              <canvas id="monthlyChart"></canvas>
            </div>
          </div>

          <!-- Totalpris -->
          <div class="card">
            <h2>Totalt forbruk</h2>
            <p class="price-line" id="price-summary-total"></p>
            <p class="price-note">Pris per enhet: 29,90 kr</p>
            <button id="reset-all-btn" class="danger">Fjern alt</button>
          </div>

          <div>
            <span class="pill">
              <span class="pill-dot"></span>
              Dine energidrikk-enheter
            </span>
          </div>

          <div id="drink-list"></div>
        </div>

        <!-- Høyre side: Leaderboard -->
        <div class="app-side">
          <div class="card">
            <h2>Leaderboard</h2>
            <p class="price-note">Topp 10 brukere etter totalt antall enheter.</p>
            <div id="leaderboard-list"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase (compat v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /***********************
     * 1. Firebase-oppsett *
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyAgxiIs24NqgdecwlRNKm6EuAZbfbjgaeg",
      authDomain: "energiteller.firebaseapp.com",
      projectId: "energiteller",
      storageBucket: "energiteller.appspot.com",
      messagingSenderId: "891350536936",
      appId: "1:891350536936:web:5455d4963df7f34429ef5d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /**************************
     * 2. Data: sorter/smaker *
     **************************/
    const brands = [
      {
        id: "monster",
        name: "Monster",
        flavors: [
          { id: "ultra-white", name: "Ultra White" },
          { id: "mango-loco", name: "Mango Loco" },
          { id: "original", name: "Original" },
          { id: "original-sukkerfri", name: "Original sukkerfri" },
          { id: "ultra-strawberry-dreams", name: "Ultra Strawberry Dreams" },
          { id: "ultra-peachy", name: "Ultra Peachy" },
          { id: "ultra-paradise", name: "Ultra Paradise" },
          { id: "ultra-rosa", name: "Ultra Rosa" },
          { id: "aussie-lemonade", name: "Aussie Lemonade" },
          { id: "juiced-bad-apple", name: "Juiced Bad Apple" },
          { id: "juiced-monarch", name: "Juiced Monarch" },
          { id: "pipeline-punch", name: "Pipeline Punch" },
          { id: "pacific-punch", name: "Pacific Punch" },
          { id: "lewis-hamilton-zero", name: "Lewis Hamilton Zero" },
          { id: "ultra-fiesta-mango", name: "Ultra Fiesta Mango" },
          { id: "valentino-rossi-vr46", name: "Valentino Rossi (VR46)" },
          { id: "lando-norris-zero-sugar", name: "Lando Norris Zero Sugar" }
        ]
      },
      {
        id: "redbull",
        name: "Red Bull",
        flavors: [
          { id: "original", name: "Original" },
          { id: "sugarfree", name: "Sugarfree" },
          { id: "tropical", name: "Tropical Edition" },
          { id: "zero", name: "Zero" },
          { id: "yellow-edition", name: "Yellow Edition" },
          { id: "vannmelon", name: "Vannmelon" },
          { id: "blue-edition", name: "Blue Edition" },
          { id: "peach", name: "Peach" },
          { id: "winter-edition", name: "Winter Edition" },
          { id: "green-edition", name: "Green Edition" },
          { id: "purple-edition", name: "Purple Edition" },
          { id: "summer-edition", name: "Summer Edition" },
          { id: "pink-edition", name: "Pink Edition" },
          { id: "spring-edition", name: "Spring Edition" }
        ]
      },
      {
        id: "burn",
        name: "Burn",
        flavors: [
          { id: "original", name: "Original" },
          { id: "apple-kiwi", name: "Apple Kiwi" },
          { id: "zero-sugar", name: "Zero Sugar" }
        ]
      },
      {
        id: "powerade",
        name: "Powerade",
        flavors: [
          { id: "bla", name: "Blå" },
          { id: "gul", name: "Gul" },
          { id: "gra", name: "Grå" }
        ]
      },
      {
        id: "battery",
        name: "Battery",
        flavors: [
          { id: "original", name: "Battery Original" },
          { id: "fresh", name: "Battery Fresh" },
          { id: "blueberry", name: "Battery Blueberry" },
          { id: "peachberry", name: "Battery Peachberry" },
          { id: "zero-lemon-yuzu", name: "Battery Zero Lemon Yuzu" },
          { id: "strawberry-mint", name: "Battery Strawberry mint" },
          { id: "zero-calories", name: "Battery Zero Calories" }
        ]
      }
    ];

    const PRICE_PER_UNIT = 29.90;

    /***********************
     * 3. DOM-referanser   *
     ***********************/
    const authSection = document.getElementById("auth-section");
    const appSection = document.getElementById("app-section");
    const drinkListEl = document.getElementById("drink-list");
    const welcomeText = document.getElementById("welcome-text");
    const authError = document.getElementById("auth-error");

    const registerForm = document.getElementById("register-form");
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");

    const priceSummaryTotal = document.getElementById("price-summary-total");
    const resetAllBtn = document.getElementById("reset-all-btn");
    const leaderboardList = document.getElementById("leaderboard-list");

    /***********************
     * 4. Tilstand         *
     ***********************/
    let currentUser = null;
    let counts = {};
    let monthlyStats = {};
    let brandState = {};
    let monthlyChart = null;
    let totalUnits = 0;

    /****************************
     * 5. Hjelpefunksjoner      *
     ****************************/
    function keyFor(brandId, flavorId) {
      return brandId + "_" + flavorId;
    }

    function getCountFor(brandId, flavorId) {
      const key = keyFor(brandId, flavorId);
      return counts[key] || 0;
    }

    function clampNonNegative(x) {
      return x < 0 ? 0 : x;
    }

    function formatKr(amount) {
      if (!amount) return "0 kr";
      return amount.toFixed(2).replace(".", ",") + " kr";
    }

    function updatePriceSummary(totalCount) {
      const totalCost = totalCount * PRICE_PER_UNIT;
      priceSummaryTotal.textContent =
        "Totalt: " + totalCount + " enheter – sum: " + formatKr(totalCost);
    }

    function getMonthKey(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      return year + "-" + String(month).padStart(2, "0");
    }

    function shortEmail(email) {
      if (!email) return "(ukjent)";
      if (email.length <= 30) return email;
      const parts = email.split("@");
      if (parts.length !== 2) return email.slice(0, 27) + "...";
      const user = parts[0];
      const domain = parts[1];
      return user.slice(0, 10) + "…" + "@" + domain;
    }

    function renderDrinkList() {
      drinkListEl.innerHTML = "";

      brands.forEach(function (brand) {
        const brandDiv = document.createElement("div");
        brandDiv.className = "brand";

        const header = document.createElement("div");
        header.className = "brand-header";

        const headerLeft = document.createElement("div");
        headerLeft.className = "brand-header-left";

        const toggleIcon = document.createElement("span");
        toggleIcon.className = "brand-toggle-icon";

        let state = brandState[brand.id];
        if (!state) {
          state = { collapsed: false };
          brandState[brand.id] = state;
        }
        const collapsed = state.collapsed;
        toggleIcon.textContent = collapsed ? "▶" : "▼";

        const nameSpan = document.createElement("span");
        nameSpan.className = "brand-name";
        nameSpan.textContent = brand.name;

        headerLeft.appendChild(toggleIcon);
        headerLeft.appendChild(nameSpan);

        const totalSpan = document.createElement("span");
        totalSpan.className = "brand-total";

        let totalForBrand = 0;
        brand.flavors.forEach(function (flavor) {
          totalForBrand += getCountFor(brand.id, flavor.id);
        });
        totalSpan.textContent = "Totalt: " + totalForBrand;

        header.appendChild(headerLeft);
        header.appendChild(totalSpan);

        const body = document.createElement("div");
        body.className = "brand-body";
        if (collapsed) {
          body.classList.add("collapsed");
        }

        header.addEventListener("click", function () {
          const st = brandState[brand.id] || { collapsed: false };
          st.collapsed = !st.collapsed;
          brandState[brand.id] = st;
          body.classList.toggle("collapsed", st.collapsed);
          toggleIcon.textContent = st.collapsed ? "▶" : "▼";
        });

        brand.flavors.forEach(function (flavor) {
          const row = document.createElement("div");
          row.className = "flavor-row";

          const flavorInfo = document.createElement("div");
          flavorInfo.className = "flavor-info";

          const flavorName = document.createElement("span");
          flavorName.className = "flavor-name";
          flavorName.textContent = flavor.name;

          const flavorCount = document.createElement("span");
          flavorCount.className = "flavor-count";
          const countValue = getCountFor(brand.id, flavor.id);
          flavorCount.textContent = "Totalt drukket: " + countValue + " enheter";

          flavorInfo.appendChild(flavorName);
          flavorInfo.appendChild(flavorCount);

          const actions = document.createElement("div");
          actions.className = "flavor-actions";

          const incBtn = document.createElement("button");
          incBtn.type = "button";
          incBtn.textContent = "+1 Enhet";
          incBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            addDrink(brand.id, flavor.id, +1);
          });

          const decBtn = document.createElement("button");
          decBtn.type = "button";
          decBtn.textContent = "-1";
          decBtn.classList.add("secondary");
          if (countValue <= 0) {
            decBtn.disabled = true;
          }
          decBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            if (getCountFor(brand.id, flavor.id) > 0) {
              addDrink(brand.id, flavor.id, -1);
            }
          });

          actions.appendChild(incBtn);
          actions.appendChild(decBtn);

          row.appendChild(flavorInfo);
          row.appendChild(actions);

          body.appendChild(row);
        });

        brandDiv.appendChild(header);
        brandDiv.appendChild(body);
        drinkListEl.appendChild(brandDiv);
      });
    }

    function recalculateTotalsFromCounts() {
      let totalCount = 0;
      for (const key in counts) {
        if (Object.prototype.hasOwnProperty.call(counts, key)) {
          const value = counts[key];
          if (typeof value === "number" && value > 0) {
            totalCount += value;
          }
        }
      }
      totalUnits = totalCount;
      renderDrinkList();
      updatePriceSummary(totalCount);
    }

    function updateMonthlyChart(stats) {
      const canvas = document.getElementById("monthlyChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      const now = new Date();
      const monthsToShow = 12;
      const labels = [];
      const data = [];

      for (let i = monthsToShow - 1; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = d.getFullYear();
        const monthIndex = d.getMonth();
        const month = monthIndex + 1;
        const key = year + "-" + String(month).padStart(2, "0");
        const label = d.toLocaleDateString("no-NO", {
          month: "short",
          year: "2-digit"
        });
        labels.push(label);
        const value = stats && stats[key] ? stats[key] : 0;
        data.push(value < 0 ? 0 : value);
      }

      if (monthlyChart) {
        monthlyChart.data.labels = labels;
        monthlyChart.data.datasets[0].data = data;
        monthlyChart.update();
      } else {
        monthlyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Enheter per måned",
                data: data,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
    }

    /***********************
     * 6. Lokal lagring    *
     ***********************/
    function getLocalKey() {
      if (!currentUser || !currentUser.uid) return null;
      return "energyTracker_" + currentUser.uid;
    }

    function loadFromLocal() {
      const key = getLocalKey();
      if (!key) return { counts: {}, monthlyStats: {} };
      const raw = localStorage.getItem(key);
      if (!raw) return { counts: {}, monthlyStats: {} };
      try {
        const data = JSON.parse(raw);
        const out = { counts: {}, monthlyStats: {} };
        if (data && typeof data.counts === "object") {
          for (const k in data.counts) {
            if (typeof data.counts[k] === "number") {
              out.counts[k] = data.counts[k];
            }
          }
        }
        if (data && typeof data.monthlyStats === "object") {
          for (const k in data.monthlyStats) {
            if (typeof data.monthlyStats[k] === "number") {
              out.monthlyStats[k] = data.monthlyStats[k];
            }
          }
        }
        return out;
      } catch (e) {
        console.error("Kunne ikke lese lokal lagring:", e);
        return { counts: {}, monthlyStats: {} };
      }
    }

    function saveToLocal() {
      const key = getLocalKey();
      if (!key) return;
      const payload = { counts, monthlyStats };
      try {
        localStorage.setItem(key, JSON.stringify(payload));
      } catch (e) {
        console.error("Kunne ikke lagre lokalt:", e);
      }
    }

    /***********************
     * 7. Firestore        *
     ***********************/
    async function fetchUserDataFromServer() {
      if (!currentUser || !currentUser.uid) return { counts: {}, monthlyStats: {}, totalUnits: 0 };
      const userRef = db.collection("users").doc(currentUser.uid);
      try {
        const snap = await userRef.get();
        if (!snap.exists) return { counts: {}, monthlyStats: {}, totalUnits: 0 };
        const data = snap.data();
        const out = { counts: {}, monthlyStats: {}, totalUnits: 0 };

        if (data && typeof data.counts === "object") {
          for (const k in data.counts) {
            if (typeof data.counts[k] === "number") {
              out.counts[k] = data.counts[k];
            }
          }
        }
        if (data && typeof data.monthlyStats === "object") {
          for (const k in data.monthlyStats) {
            if (typeof data.monthlyStats[k] === "number") {
              out.monthlyStats[k] = data.monthlyStats[k];
            }
          }
        }
        if (typeof data.totalUnits === "number") {
          out.totalUnits = data.totalUnits;
        }
        return out;
      } catch (e) {
        console.error("Kunne ikke hente data fra server:", e);
        return { counts: {}, monthlyStats: {}, totalUnits: 0 };
      }
    }

    async function saveUserDataToServer() {
      if (!currentUser || !currentUser.uid) return;
      const userRef = db.collection("users").doc(currentUser.uid);
      try {
        await userRef.set(
          {
            email: currentUser.email || "",
            counts: counts,
            monthlyStats: monthlyStats,
            totalUnits: totalUnits
          },
          { merge: true }
        );
      } catch (e) {
        console.error("Kunne ikke lagre til server:", e);
      }
    }

    function applyData(data) {
      counts = data.counts || {};
      monthlyStats = data.monthlyStats || {};
      recalculateTotalsFromCounts();
      updateMonthlyChart(monthlyStats);
      saveToLocal();
    }

    /***********************
     * 8. Leaderboard      *
     ***********************/
    async function loadLeaderboard() {
      if (!leaderboardList) return;
      leaderboardList.textContent = "Laster...";
      try {
        const snap = await db.collection("users").get();
        const entries = [];

        snap.forEach(function (docSnap) {
          const data = docSnap.data() || {};
          let total = 0;
          if (data.counts && typeof data.counts === "object") {
            for (const key in data.counts) {
              if (Object.prototype.hasOwnProperty.call(data.counts, key)) {
                const v = data.counts[key];
                if (typeof v === "number" && v > 0) {
                  total += v;
                }
              }
            }
          }
          const email = shortEmail(data.email || "");
          entries.push({ email, total });
        });

        // sorter lokalt etter total
        entries.sort((a, b) => b.total - a.total);

        leaderboardList.innerHTML = "";
        if (entries.length === 0) {
          leaderboardList.textContent = "Ingen data ennå.";
          return;
        }

        entries.slice(0, 10).forEach((entry, idx) => {
          const row = document.createElement("div");
          row.className = "leader-row";

          const nameSpan = document.createElement("span");
          nameSpan.className = "leader-name";
          nameSpan.textContent = (idx + 1) + ". " + (entry.email || "(ukjent)");

          const valueSpan = document.createElement("span");
          valueSpan.className = "leader-value";
          valueSpan.textContent = entry.total + " enheter";

          row.appendChild(nameSpan);
          row.appendChild(valueSpan);
          leaderboardList.appendChild(row);
        });
      } catch (e) {
        console.error("Kunne ikke laste leaderboard:", e);
        leaderboardList.textContent = "Kunne ikke laste leaderboard.";
      }
    }

    /****************************
     * 9. +1 / -1 og Fjern alt  *
     ****************************/
    async function addDrink(brandId, flavorId, delta) {
      if (!currentUser || !currentUser.uid) return;

      const key = keyFor(brandId, flavorId);
      const current = counts[key] || 0;
      const next = current + delta;
      if (next < 0) return;

      counts[key] = next;

      const now = new Date();
      const monthKey = getMonthKey(now);
      monthlyStats[monthKey] = clampNonNegative((monthlyStats[monthKey] || 0) + delta);

      recalculateTotalsFromCounts();
      updateMonthlyChart(monthlyStats);
      saveToLocal();
      await saveUserDataToServer();
      await loadLeaderboard();
    }

    if (resetAllBtn) {
      resetAllBtn.addEventListener("click", async function () {
        if (!currentUser || !currentUser.uid) return;
        const sure = confirm("Er du sikker på at du vil fjerne alle tallene?");
        if (!sure) return;

        counts = {};
        monthlyStats = {};
        totalUnits = 0;
        recalculateTotalsFromCounts();
        updateMonthlyChart(monthlyStats);
        saveToLocal();
        await saveUserDataToServer();
        await loadLeaderboard();
      });
    }

    /*****************************
     * 10. Innlogging/registrering *
     *****************************/
    registerForm.addEventListener("submit", async function (event) {
      event.preventDefault();
      authError.textContent = "";

      const email = document.getElementById("register-email").value.trim();
      const password = document.getElementById("register-password").value;

      try {
        await auth.createUserWithEmailAndPassword(email, password);
        registerForm.reset();
      } catch (error) {
        console.error(error);
        authError.textContent = error.message || "Noe gikk galt ved registrering.";
      }
    });

    loginForm.addEventListener("submit", async function (event) {
      event.preventDefault();
      authError.textContent = "";

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        await auth.signInWithEmailAndPassword(email, password);
        loginForm.reset();
      } catch (error) {
        console.error(error);
        authError.textContent = "Kunne ikke logge inn. Sjekk e-post og passord.";
      }
    });

    logoutBtn.addEventListener("click", function () {
      auth.signOut();
    });

    auth.onAuthStateChanged(async function (user) {
      currentUser = user;

      if (user) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        welcomeText.textContent = "Innlogget som " + (user.email || "");

        const localData = loadFromLocal();
        applyData(localData);

        const serverData = await fetchUserDataFromServer();
        if (
          Object.keys(serverData.counts).length > 0 ||
          Object.keys(serverData.monthlyStats).length > 0 ||
          serverData.totalUnits > 0
        ) {
          applyData(serverData);
        } else if (
          Object.keys(localData.counts).length > 0 ||
          Object.keys(localData.monthlyStats).length > 0
        ) {
          await saveUserDataToServer();
        }

        await loadLeaderboard();
      } else {
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        welcomeText.textContent = "";
        counts = {};
        monthlyStats = {};
        brandState = {};
        totalUnits = 0;
        recalculateTotalsFromCounts();
        updateMonthlyChart(monthlyStats);
        if (leaderboardList) leaderboardList.textContent = "";
      }
    });
  </script>
</body>
</html>
